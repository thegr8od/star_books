pipeline {
    agent any

    environment {
        FRONTEND_BRANCH = 'feature-frontend'
    }

    stages {
        stage('Load Credentials') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'FRONT_MESSAGE', variable: 'MATTERMOST_WEBHOOK_URL'),
                        string(credentialsId: 'NGINX_CONTAINER_NAME', variable: 'NGINX_CONTAINER_NAME'),
                        string(credentialsId: 'FRONTEND_IMAGE_NAME', variable: 'FRONTEND_IMAGE_NAME'),
                        string(credentialsId: 'DIST_PATH', variable: 'DIST_PATH'),
                        string(credentialsId: 'HOST_DIST_PATH', variable: 'HOST_DIST_PATH')
                    ]) {
                        env.MATTERMOST_WEBHOOK_URL = MATTERMOST_WEBHOOK_URL
                        env.NGINX_CONTAINER_NAME = NGINX_CONTAINER_NAME
                        env.FRONTEND_IMAGE_NAME = FRONTEND_IMAGE_NAME
                        env.DIST_PATH = DIST_PATH
                        env.HOST_DIST_PATH = HOST_DIST_PATH
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('frontend') {  
                        sh '''#!/bin/bash
                        docker build -t "$FRONTEND_IMAGE_NAME" .
                        '''
                    }
                }
            }
        }

        stage('Deploy Frontend') {
            steps {
                script {
                    sh '''#!/bin/bash
                    docker rm -f frontend-container || true
                    docker create --name frontend-container "$FRONTEND_IMAGE_NAME"
                    docker start frontend-container
                    docker exec "$NGINX_CONTAINER_NAME" rm -rf "$DIST_PATH"/*
                    rm -rf "$HOST_DIST_PATH"
                    mkdir -p "$HOST_DIST_PATH"
                    docker cp frontend-container:/dist/. "$HOST_DIST_PATH"/
                    docker cp "$HOST_DIST_PATH"/. "$NGINX_CONTAINER_NAME":"$DIST_PATH"/
                    docker restart "$NGINX_CONTAINER_NAME"
                    '''
                }
            }
        }
    }

    post {
        success {
            script {
                def buildResult = currentBuild.result ?: 'SUCCESS'
                def jsonMessage = """{
                    "text": "✅ *Frontend Build 성공*
                    - 상태: ${buildResult}"
                }"""

                sh """
                echo '${jsonMessage}' > mattermost_payload.json
                curl -X POST -H "Content-Type: application/json" --data @mattermost_payload.json '${MATTERMOST_WEBHOOK_URL}'
                rm -f mattermost_payload.json
                """
            }
        }
        failure {
            script {
                def buildResult = currentBuild.result ?: 'FAILURE'
                def jsonMessage = """{
                    "text": "❌ *Frontend Build 실패*
                    - 상태: ${buildResult}"
                }"""

                sh """
                echo '${jsonMessage}' > mattermost_payload.json
                curl -X POST -H "Content-Type: application/json" --data @mattermost_payload.json '${MATTERMOST_WEBHOOK_URL}'
                rm -f mattermost_payload.json
                """
            }
        }
    }
}
