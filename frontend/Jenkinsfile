pipeline {
    agent any

    environment {
        GIT_PROJECT_URL = credentials('GITLAB_PROJECT_URL')
        GIT_CREDENTIALS_ID = credentials('SER')
        FRONTEND_BRANCH = credentials('FRONTEND_BRANCH')
        MATTERMOST_WEBHOOK_URL = credentials('FRONT_MESSAGE')
        NGINX_CONTAINER_NAME = credentials('NGINX_CONTAINER_NAME')
        FRONTEND_IMAGE_NAME = credentials('FRONTEND_IMAGE_NAME')
        DIST_PATH = credentials('DIST_PATH')
        HOST_DIST_PATH = credentials('HOST_DIST_PATH')
    }

    stages {
        stage('Clone Repository') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.FRONTEND_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: env.GIT_PROJECT_URL,
                        credentialsId: env.GIT_CREDENTIALS_ID
                    ]]
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('frontend') {  
                        sh 'docker build -t ${env.FRONTEND_IMAGE_NAME} .'  // Build Docker image
                    }
                }
            }
        }

        stage('Deploy Frontend') {
            steps {
                script {
                    sh '''
                    docker rm -f frontend-container || true
                    docker create --name frontend-container ${env.FRONTEND_IMAGE_NAME}
                    docker exec ${env.NGINX_CONTAINER_NAME} rm -rf ${env.DIST_PATH}/*
                    rm -rf ${env.HOST_DIST_PATH}
                    mkdir -p ${env.HOST_DIST_PATH}
                    docker cp frontend-container:/dist/. ${env.HOST_DIST_PATH}/
                    docker cp ${env.HOST_DIST_PATH}/. ${env.NGINX_CONTAINER_NAME}:${env.DIST_PATH}/
                    docker rm frontend-container
                    '''
                }
            }
        }
    }

    post {
        success {
            script {
                def message = """{
                    "text": "✅ *Frontend Build 성공*\n- 상태: ${currentBuild.result}\n- 상세 정보: ${env.BUILD_URL}"
                }"""
                sh "curl -X POST -H 'Content-Type: application/json' -d '${message}' ${env.MATTERMOST_WEBHOOK_URL}"
            }
        }
        failure {
            script {
                def message = """{
                    "text": "❌ *Frontend Build 실패*\n- 상태: ${currentBuild.result}\n- 상세 정보: ${env.BUILD_URL}/console"
                }"""
                sh "curl -X POST -H 'Content-Type: application/json' -d '${message}' ${env.MATTERMOST_WEBHOOK_URL}"
            }
        }
    }
}
